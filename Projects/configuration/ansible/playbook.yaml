- name: Environment Setup
  hosts: all
  gather_facts: true
  become: false
  vars:
    linux_desktop: "{{ ('XDG_CURRENT_DESKTOP' in ansible_env) and (ansible_env.XDG_CURRENT_DESKTOP|length > 0) }}"
    thinkpad: "{{ ansible_product_version is regex('ThinkPad') }}"
  tasks:
    - name: Install and configure platform specific settings
      include_tasks: "platform/{{ ansible_distribution }}.yaml"
    - name: Install cargo update tool
      command:
        cmd: cargo install cargo-update
        creates: ~/.cargo/bin/cargo-install-update
    - name: Update cargo packages
      command:
        cmd: cargo install-update --all
      register: cargo_update
      changed_when: cargo_update.stdout.find('No packages need updating.') == -1
    - name: Install hostess cli
      command:
        cmd: go get -u github.com/cbednarski/hostess
        creates: ~/.go/bin/hostess
      environment:
        GOPATH: "{{ ansible_env.HOME }}/.go"
    # Language package manager content, should be managed by a package config
    # file for contents rather than managed here
    - name: Register npm major version
      shell:
        cmd: |
          npm --version | awk 'BEGIN { FS = "." } ; { print $1 }'
      register: npm_version
      changed_when: false
    - name: NPM configuration (globalconfig) (versions <7)
      include_tasks: "npm/globalconfig.yaml"
      when: npm_version.stdout | int < 7
    - name: NPM configuration (userconfig) (versions 7+)
      include_tasks: "npm/userconfig.yaml"
      when: npm_version.stdout | int >= 7
    - name: Update composer packages
      community.general.composer:
        no_dev: false
        command: update
        global_command: true
      environment:
        COMPOSER_HOME: "{{ ansible_env.HOME }}/.config/composer"
    - name: package sources
      git:
        repo: https://github.com/{{ item.owner }}/{{ item.repo }}
        dest: ~/.local/src/{{ item.repo }}
        depth: 1
        force: true # disregard local changes
      loop:
        - owner: dexpota
          repo: kitty-themes
        - owner: kittykatt
          repo: screenfetch
        - owner: muennich
          repo: urxvt-perls
    - name: vim bundles
      git:
        repo: https://github.com/{{ item.owner }}/{{ item.repo }}
        dest: ~/.vim/bundle/{{ item.repo }}
        depth: 1
        force: true # disregard local changes
      loop:
        - owner: adelarsq
          repo: vim-matchit
        - owner: cespare
          repo: vim-toml
        - owner: chrisbra
          repo: csv.vim
        - owner: editorconfig
          repo: editorconfig-vim
        - owner: fatih
          repo: vim-go
        - owner: flazz
          repo: vim-colorschemes
        - owner: idanarye
          repo: vim-vebugger
        - owner: leafgarland
          repo: typescript-vim
        - owner: lumiliet
          repo: vim-twig
        - owner: martinda
          repo: jenkinsfile-vim-syntax
        - owner: mattn
          repo: emmet-vim
        - owner: pearofducks
          repo: ansible-vim
        - owner: plasticboy
          repo: vim-markdown
        - owner: quramy
          repo: tsuquyomi
        - owner: rust-lang
          repo: rust.vim
        - owner: ryanoasis
          repo: vim-devicons
        - owner: sbdchd
          repo: neoformat
        - owner: scrooloose
          repo: nerdtree
        - owner: shougo
          repo: vimproc.vim
        - owner: towolf
          repo: vim-helm
        - owner: tpope
          repo: vim-fugitive
        - owner: tpope
          repo: vim-liquid
        - owner: vim-syntastic
          repo: syntastic
- name: Non-local updates
  # localhost takes care of itself outside of ansible
  hosts: "!localhost"
  gather_facts: false
  become: false
  tasks:
    - name: Ensure yadm is up to date
      command:
        cmd: "yadm pull origin main"
      register: yadm_update
      changed_when: "yadm_update.stdout is not regex('Already up to date')"
